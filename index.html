<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>tutorCRM</title>
    <!-- Подключаем шрифт Pacifico -->
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        /* Стили для навигационных вкладок */
        .tabs {
            margin-bottom: 20px;
        }
        .tabs button {
            background-color: #f1f1f1;
            border: none;
            outline: none;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 5px;
        }
        .tabs button:hover {
            background-color: #ddd;
        }
        .tabs button.active {
            background-color: #ccc;
        }
        /* Стили для секций */
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        form {
            max-width: 400px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="datetime-local"], input[type="number"],
        input[type="date"], input[type="time"], textarea, select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            height: 80px;
        }
        button[type="submit"] {
            padding: 10px 15px;
            cursor: pointer;
        }
        /* Таблица для отображения данных */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        table, th, td {
            border: 1px solid #999;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        /* Стили для календаря */
        .calendar {
            width: 100%;
            margin-top: 20px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .calendar-nav {
            display: flex;
            gap: 10px;
        }
        .calendar-nav button {
            padding: 5px 10px;
            background-color: #f1f1f1;
            border: none;
            cursor: pointer;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .calendar-day-header {
            background-color: #f1f1f1;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
        .calendar-day {
            min-height: 100px;
            border: 1px solid #ddd;
            padding: 10px;
            cursor: pointer;
            color: #000;
            background-color: #fff;
            transition: background-color 0.3s;
        }
        .calendar-day:hover {
            background-color: #f9f9f9;
        }
        .calendar-day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .calendar-event {
            background-color: #e3f2fd;
            border-left: 3px solid #2196f3;
            padding: 3px 5px;
            margin-bottom: 3px;
            font-size: 12px;
            border-radius: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .today {
            background-color: #fff8e1;
            color: #000;
        }
        .other-month {
            color: #ccc;
            background-color: #f9f9f9;
        }
        /* Стили для модального окна добавления события */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            width: 50%;
            max-width: 500px;
            border-radius: 5px;
        }
        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: red;
        }
        /* Стили для тёмной темы */
        body.dark-theme {
            background-color: #000;
            color: #fff;
        }
        body.dark-theme input,
        body.dark-theme textarea,
        body.dark-theme select {
            background-color: #333;
            color: #fff;
        }
        body.dark-theme table,
        body.dark-theme th,
        body.dark-theme td {
            border-color: #444;
        }
        body.dark-theme .tabs button {
            background-color: #333;
            color: #fff;
        }
        /* Стили для календаря в тёмной теме */
        body.dark-theme .calendar-day {
            background-color: #333;
            border-color: #555;
            color: #fff;
        }
        body.dark-theme .calendar-day:hover {
            background-color: #444;
        }
        body.dark-theme .calendar-day-header {
            background-color: #444;
            color: #fff;
        }
        body.dark-theme .today {
            background-color: #555;
            color: #fff;
        }
        body.dark-theme .other-month {
            background-color: #222;
            color: #999;
        }
    </style>
</head>
<body>
<!-- Заголовок с новым шрифтом -->
<h1 id="mainTitle" style="font-family: 'Pacifico', cursive;">tutorCRM</h1>
<!-- Переключатель темы: иконка находится в правом верхнем углу -->
<img id="themeToggle" src="icons/moon.png" alt="Toggle Theme" style="width:32px; height:32px; cursor:pointer; position: absolute; top: 20px; right: 20px;">
<!-- Переключатель языка: располагается рядом с темой -->
<img id="languageToggle" src="icons/Russian_flag.png" alt="Toggle Language" style="width:32px; height:32px; cursor:pointer; position: absolute; top: 20px; right: 70px;">

<!-- Навигационные вкладки -->
<div class="tabs">
    <button id="navStudents" class="tab-button active" data-target="studentsSection" data-lang-key="nav.students">Ученики</button>
    <button id="navSchedule" class="tab-button" data-target="scheduleSection" data-lang-key="nav.schedule">Расписание</button>
    <button id="navCalendar" class="tab-button" data-target="calendarSection" data-lang-key="nav.calendar">Календарь</button>
</div>

<!-- Секция для учеников -->
<div id="studentsSection" class="section active">
    <h2 id="studentsHeading" data-lang-key="studentsHeading">Управление учениками</h2>
    <form id="studentForm">
        <div class="form-group">
            <label for="firstName" data-lang-key="fields.firstNameLabel">Имя</label>
            <input type="text" id="firstName" name="firstName"
                   data-placeholder-key="fields.firstNamePlaceholder"
                   placeholder="Введите имя" required>
        </div>
        <div class="form-group">
            <label for="lastName" data-lang-key="fields.lastNameLabel">Фамилия</label>
            <input type="text" id="lastName" name="lastName"
                   data-placeholder-key="fields.lastNamePlaceholder"
                   placeholder="Введите фамилию" required>
        </div>
        <div class="form-group">
            <label for="class" data-lang-key="fields.classLabel">Класс</label>
            <input type="text" id="class" name="class"
                   data-placeholder-key="fields.classPlaceholder"
                   placeholder="Введите класс" required>
        </div>
        <div class="form-group">
            <label for="description" data-lang-key="fields.descriptionLabel">Описание ученика</label>
            <textarea id="description" name="description"
                      data-placeholder-key="fields.descriptionPlaceholder"
                      placeholder="Введите описание"></textarea>
        </div>
        <button type="submit" id="addStudentBtn" data-lang-key="buttons.addStudent">Добавить ученика</button>
    </form>
    <!-- Поиск ученика -->
    <div class="search-container">
        <label for="studentSearch" id="studentSearchLabel" data-lang-key="fields.searchStudentLabel">Поиск ученика:</label>
        <input type="text" id="studentSearch"
               data-placeholder-key="fields.searchStudentPlaceholder"
               placeholder="Введите имя, фамилию или класс">
    </div>
    <!-- Список учеников -->
    <h3 id="studentsListHeading" data-lang-key="headings.studentList">Список учеников</h3>
    <table id="studentsTable">
        <thead>
        <tr>
            <th data-lang-key="fields.firstNameLabel">Имя</th>
            <th data-lang-key="fields.lastNameLabel">Фамилия</th>
            <th data-lang-key="fields.classLabel">Класс</th>
            <th data-lang-key="fields.descriptionLabel">Описание</th>
        </tr>
        </thead>
        <tbody>
            <!-- Строки будут добавляться динамически -->
        </tbody>
    </table>
</div>

<!-- Секция для расписания -->
<div id="scheduleSection" class="section">
    <h2 id="scheduleHeading" data-lang-key="scheduleHeading">Расписание занятий</h2>
    <form id="scheduleForm">
        <div class="form-group">
            <label for="lessonTitle" data-lang-key="fields.lessonTitleLabel">Название занятия</label>
            <input type="text" id="lessonTitle" name="lessonTitle"
                   data-placeholder-key="fields.lessonTitlePlaceholder"
                   placeholder="Введите название занятия" required>
        </div>
        <div class="form-group">
            <label for="lessonDateTime" data-lang-key="fields.lessonDateTimeLabel">Дата и время</label>
            <input type="datetime-local" id="lessonDateTime" name="lessonDateTime" required>
        </div>
        <div class="form-group">
            <label for="studentSelect" data-lang-key="fields.lessonStudentLabel">Ученик</label>
            <select id="studentSelect" name="studentSelect" required>
                <option value="" data-lang-key="fields.selectStudentOption">Выберите ученика</option>
            </select>
        </div>
        <div class="form-group">
            <label for="lessonNotes" data-lang-key="fields.lessonNotesLabel">Заметки</label>
            <textarea id="lessonNotes" name="lessonNotes"
                      data-placeholder-key="fields.lessonNotesPlaceholder"
                      placeholder="Введите заметки о занятии"></textarea>
        </div>
        <button type="submit" id="addLessonBtn" data-lang-key="buttons.addLesson">Добавить занятие</button>
    </form>
    <h3 id="scheduledLessonsHeading" data-lang-key="headings.scheduledLessons">Запланированные занятия</h3>
    <table id="scheduleTable">
        <thead>
        <tr>
            <th data-lang-key="fields.lessonTitleLabel">Название</th>
            <th data-lang-key="fields.lessonDateTimeLabel">Дата и время</th>
            <th data-lang-key="fields.lessonStudentLabel">Ученик</th>
            <th data-lang-key="fields.lessonNotesLabel">Заметки</th>
            <th data-lang-key="headings.actions">Действия</th>
        </tr>
        </thead>
        <tbody>
            <!-- Строки будут добавляться динамически -->
        </tbody>
    </table>
</div>

<!-- Секция для календаря -->
<div id="calendarSection" class="section">
    <h2 id="calendarHeading" data-lang-key="calendarHeading">Календарь занятий</h2>
    <div class="calendar">
        <div class="calendar-header">
            <h3 id="currentMonthYear">март 2025</h3>
            <div class="calendar-nav">
                <button id="prevMonth" data-lang-key="calendarNav.prev">⟨ Предыдущий</button>
                <button id="today" data-lang-key="calendarNav.today">Сегодня</button>
                <button id="nextMonth" data-lang-key="calendarNav.next">Следующий ⟩</button>
            </div>
        </div>
        <div class="calendar-grid" id="calendarGrid">
            <!-- Заголовки дней недели -->
            <div class="calendar-day-header">ПН</div>
            <div class="calendar-day-header">ВТ</div>
            <div class="calendar-day-header">СР</div>
            <div class="calendar-day-header">ЧТ</div>
            <div class="calendar-day-header">ПТ</div>
            <div class="calendar-day-header">СБ</div>
            <div class="calendar-day-header">ВС</div>
            <!-- Дни календаря будут добавляться динамически -->
        </div>
    </div>
</div>

<!-- Секция платежей -->
<div id="paymentsSection" class="section">
    <h2 id="paymentsHeading" data-lang-key="paymentsHeading">Финансовый учет</h2>
    <form id="paymentForm">
        <div class="form-group">
            <label for="paymentStudent" data-lang-key="fields.paymentStudentLabel">Ученик</label>
            <select id="paymentStudent" name="paymentStudent" required>
                <option value="" data-lang-key="fields.selectStudentOption">Выберите ученика</option>
            </select>
        </div>
        <div class="form-group">
            <label for="paymentAmount" data-lang-key="fields.paymentAmountLabel">Сумма (₽)</label>
            <input type="number" id="paymentAmount" name="paymentAmount" step="0.01" required>
        </div>
        <div class="form-group">
            <label for="paymentDate" data-lang-key="fields.paymentDateLabel">Дата платежа</label>
            <input type="date" id="paymentDate" name="paymentDate" required>
        </div>
        <div class="form-group">
            <label for="paymentMethod" data-lang-key="fields.paymentMethodLabel">Способ оплаты</label>
            <select id="paymentMethod" name="paymentMethod" required>
                <option value="Наличные" data-lang-key="fields.paymentCashOption">Наличные</option>
                <option value="Перевод" data-lang-key="fields.paymentTransferOption">Банковский перевод</option>
                <option value="Карта" data-lang-key="fields.paymentCardOption">Банковская карта</option>
            </select>
        </div>
        <div class="form-group">
            <label for="paymentDescription" data-lang-key="fields.paymentDescriptionLabel">Описание</label>
            <textarea id="paymentDescription" name="paymentDescription"
                      data-placeholder-key="fields.paymentDescriptionPlaceholder"
                      placeholder="Введите описание платежа"></textarea>
        </div>
        <button type="submit" id="addPaymentBtn" data-lang-key="buttons.addPayment">Добавить платеж</button>
    </form>
    <h3 data-lang-key="headings.paymentHistory">История платежей</h3>
    <div class="filter-controls">
        <label for="paymentStudentFilter" data-lang-key="headings.paymentStudentFilter">Фильтр по ученику:</label>
        <select id="paymentStudentFilter">
            <option value="" data-lang-key="fields.allStudentsOption">Все ученики</option>
            <!-- Опции будут добавляться динамически -->
        </select>
    </div>
    <div id="totalPaymentAmount" class="total-amount" data-lang-key="headings.totalAmountPrefix">Итого: 0.00 ₽</div>
    <table id="paymentsTable">
        <thead>
        <tr>
            <th data-lang-key="fields.paymentDateLabel">Дата</th>
            <th data-lang-key="fields.paymentStudentLabel">Ученик</th>
            <th data-lang-key="fields.paymentAmountLabel">Сумма</th>
            <th data-lang-key="fields.paymentDescriptionLabel">Описание</th>
            <th data-lang-key="fields.paymentMethodLabel">Способ оплаты</th>
            <th data-lang-key="headings.actions">Действия</th>
        </tr>
        </thead>
        <tbody>
            <!-- Строки будут добавляться динамически -->
        </tbody>
    </table>
</div>

<!-- Модальное окно для добавления события в календаре -->
<div id="eventModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 data-lang-key="headings.addLessonModal">Добавить занятие</h3>
        <form id="calendarEventForm">
            <input type="hidden" id="eventDate" name="eventDate">
            <div class="form-group">
                <label for="eventTitle" data-lang-key="fields.lessonTitleLabel">Название занятия</label>
                <input type="text" id="eventTitle" name="eventTitle"
                       data-placeholder-key="fields.lessonTitlePlaceholder"
                       placeholder="Введите название занятия" required>
            </div>
            <div class="form-group">
                <label for="eventTime" data-lang-key="fields.eventTimeLabel">Время</label>
                <input type="time" id="eventTime" name="eventTime" required>
            </div>
            <div class="form-group">
                <label for="eventStudent" data-lang-key="fields.lessonStudentLabel">Ученик</label>
                <select id="eventStudent" name="eventStudent" required>
                    <option value="" data-lang-key="fields.selectStudentOption">Выберите ученика</option>
                </select>
            </div>
            <div class="form-group">
                <label for="eventNotes" data-lang-key="fields.lessonNotesLabel">Заметки</label>
                <textarea id="eventNotes" name="eventNotes"
                          data-placeholder-key="fields.lessonNotesPlaceholder"
                          placeholder="Введите заметки о занятии"></textarea>
            </div>
            <button type="submit" data-lang-key="buttons.saveLesson">Сохранить</button>
        </form>
    </div>
</div>

<script>
    // --- ДАННЫЕ ---

    // Основные массивы (ученики, занятия, события в календаре, платежи)
    const studentsData = [];
    const schedulesData = [];
    const calendarEvents = {};
    const paymentsData = [];

    // Текущий язык
    let currentLanguage = 'ru';

    // Текущая дата календаря
    let currentCalendarDate = new Date();

    // --- ПЕРЕВОДЫ ---

    const translations = {
        ru: {
            title: "tutorCRM",
            nav: {
                students: "Ученики",
                schedule: "Расписание",
                calendar: "Календарь",
                payments: "Платежи"
            },
            studentsHeading: "Управление учениками",
            scheduleHeading: "Расписание занятий",
            calendarHeading: "Календарь занятий",
            paymentsHeading: "Финансовый учет",

            // Заголовки таблиц и пр.
            headings: {
                studentList: "Список учеников",
                scheduledLessons: "Запланированные занятия",
                paymentHistory: "История платежей",
                paymentStudentFilter: "Фильтр по ученику:",
                totalAmountPrefix: "Итого: 0.00 ₽",
                actions: "Действия",
                addLessonModal: "Добавить занятие"
            },

            // Поля, плейсхолдеры
            fields: {
                // Ученики
                firstNameLabel: "Имя",
                firstNamePlaceholder: "Введите имя",
                lastNameLabel: "Фамилия",
                lastNamePlaceholder: "Введите фамилию",
                classLabel: "Класс",
                classPlaceholder: "Введите класс",
                descriptionLabel: "Описание ученика",
                descriptionPlaceholder: "Введите описание",
                searchStudentLabel: "Поиск ученика:",
                searchStudentPlaceholder: "Введите имя, фамилию или класс",

                // Занятия
                lessonTitleLabel: "Название занятия",
                lessonTitlePlaceholder: "Введите название занятия",
                lessonDateTimeLabel: "Дата и время",
                lessonStudentLabel: "Ученик",
                lessonNotesLabel: "Заметки",
                lessonNotesPlaceholder: "Введите заметки о занятии",
                selectStudentOption: "Выберите ученика",
                eventTimeLabel: "Время",

                // Платежи
                paymentStudentLabel: "Ученик",
                paymentAmountLabel: "Сумма (₽)",
                paymentDateLabel: "Дата платежа",
                paymentMethodLabel: "Способ оплаты",
                paymentDescriptionLabel: "Описание",
                paymentDescriptionPlaceholder: "Введите описание платежа",
                paymentCashOption: "Наличные",
                paymentTransferOption: "Банковский перевод",
                paymentCardOption: "Банковская карта",
                allStudentsOption: "Все ученики"
            },

            // Календарь
            calendarNav: {
                prev: "⟨ Предыдущий",
                today: "Сегодня",
                next: "Следующий ⟩"
            },

            // Кнопки
            buttons: {
                addStudent: "Добавить ученика",
                addLesson: "Добавить занятие",
                addPayment: "Добавить платеж",
                saveLesson: "Сохранить"
            }
        },
        en: {
            title: "tutorCRM",
            nav: {
                students: "Students",
                schedule: "Schedule",
                calendar: "Calendar",
                payments: "Payments"
            },
            studentsHeading: "Student Management",
            scheduleHeading: "Lesson Schedule",
            calendarHeading: "Lesson Calendar",
            paymentsHeading: "Financial Management",

            headings: {
                studentList: "Student List",
                scheduledLessons: "Scheduled Lessons",
                paymentHistory: "Payment History",
                paymentStudentFilter: "Filter by Student:",
                totalAmountPrefix: "Total: 0.00 ₽",
                actions: "Actions",
                addLessonModal: "Add Lesson"
            },

            fields: {
                // Students
                firstNameLabel: "First Name",
                firstNamePlaceholder: "Enter first name",
                lastNameLabel: "Last Name",
                lastNamePlaceholder: "Enter last name",
                classLabel: "Class",
                classPlaceholder: "Enter class",
                descriptionLabel: "Student Description",
                descriptionPlaceholder: "Enter student description",
                searchStudentLabel: "Search student:",
                searchStudentPlaceholder: "Enter first name, last name or class",

                // Lessons
                lessonTitleLabel: "Lesson Title",
                lessonTitlePlaceholder: "Enter lesson title",
                lessonDateTimeLabel: "Date & Time",
                lessonStudentLabel: "Student",
                lessonNotesLabel: "Notes",
                lessonNotesPlaceholder: "Enter lesson notes",
                selectStudentOption: "Select student",
                eventTimeLabel: "Time",

                // Payments
                paymentStudentLabel: "Student",
                paymentAmountLabel: "Amount (₽)",
                paymentDateLabel: "Payment Date",
                paymentMethodLabel: "Payment Method",
                paymentDescriptionLabel: "Description",
                paymentDescriptionPlaceholder: "Enter payment description",
                paymentCashOption: "Cash",
                paymentTransferOption: "Bank Transfer",
                paymentCardOption: "Bank Card",
                allStudentsOption: "All Students"
            },

            calendarNav: {
                prev: "Previous",
                today: "Today",
                next: "Next"
            },

            buttons: {
                addStudent: "Add Student",
                addLesson: "Add Lesson",
                addPayment: "Add Payment",
                saveLesson: "Save"
            }
        }
    };

    // --- ФУНКЦИИ ПЕРЕКЛЮЧЕНИЯ ЯЗЫКА ---

    function updateLanguage() {
        // 1) Заголовок вкладки браузера
        document.title = translations[currentLanguage].title;

        // 2) Обновляем элементы с data-lang-key
        const langElements = document.querySelectorAll("[data-lang-key]");
        langElements.forEach((el) => {
            const keyPath = el.getAttribute("data-lang-key").split(".");
            // keyPath[0] может быть 'fields', 'buttons', 'headings', etc.
            // keyPath[1] может быть 'firstNameLabel' и т.д.
            let translation = translations[currentLanguage];
            keyPath.forEach((part) => {
                if (translation && translation[part] !== undefined) {
                    translation = translation[part];
                }
            });
            if (typeof translation === "string") {
                el.textContent = translation;
            }
        });

        // 3) Обновляем плейсхолдеры
        const placeholderElements = document.querySelectorAll("[data-placeholder-key]");
        placeholderElements.forEach((el) => {
            const keyPath = el.getAttribute("data-placeholder-key").split(".");
            let translation = translations[currentLanguage];
            keyPath.forEach((part) => {
                if (translation && translation[part] !== undefined) {
                    translation = translation[part];
                }
            });
            if (typeof translation === "string") {
                el.placeholder = translation;
            }
        });

        // 4) Обновляем <option> внутри <select> (например, "Все ученики" / "All Students")
        //    Их тоже помечаем data-lang-key. При смене языка меняем textContent.
        const optionElements = document.querySelectorAll("option[data-lang-key]");
        optionElements.forEach((opt) => {
            const keyPath = opt.getAttribute("data-lang-key").split(".");
            let translation = translations[currentLanguage];
            keyPath.forEach((part) => {
                if (translation && translation[part] !== undefined) {
                    translation = translation[part];
                }
            });
            if (typeof translation === "string") {
                opt.textContent = translation;
            }
        });

        // 5) Пример: нужно обновить текст "Итого: 0.00 ₽" в блоке #totalPaymentAmount
        //    По сути он уже в data-lang-key, значит обновится в шаге (2).
        //    Если требуется динамика (например, 0.00 может меняться), можно дописать логику вручную.
    }

    function setupLanguageToggle() {
        const languageToggle = document.getElementById('languageToggle');
        languageToggle.addEventListener('click', () => {
            if (currentLanguage === 'ru') {
                currentLanguage = 'en';
                languageToggle.src = 'icons/American_flag.png';
            } else {
                currentLanguage = 'ru';
                languageToggle.src = 'icons/Russian_flag.png';
            }
            updateLanguage();
        });
    }

    // --- ТЕМА ---

    function setupThemeToggle() {
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            if (document.body.classList.contains('dark-theme')) {
                document.body.classList.remove('dark-theme');
                themeToggle.src = 'icons/moon.png'; // светлая тема
            } else {
                document.body.classList.add('dark-theme');
                themeToggle.src = 'icons/sun.png'; // тёмная тема
            }
        });
    }

    // --- ВКЛАДКИ ---

    function setupTabs() {
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                button.classList.add('active');
                const targetId = button.getAttribute('data-target');
                document.getElementById(targetId).classList.add('active');
            });
        });
    }

    // --- ЛОГИКА ДЛЯ УЧЕНИКОВ ---

    function setupStudentForm() {
        const studentForm = document.getElementById('studentForm');
        studentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const studentClass = document.getElementById('class').value;
            const description = document.getElementById('description').value;

            const studentIdInput = document.getElementById('studentId');
            if (studentIdInput && studentIdInput.value) {
                // Редактирование
                const studentId = parseInt(studentIdInput.value);
                const index = studentsData.findIndex(s => s.id === studentId);
                if (index !== -1) {
                    studentsData[index].firstName = firstName;
                    studentsData[index].lastName = lastName;
                    studentsData[index].class = studentClass;
                    studentsData[index].description = description;
                    studentIdInput.value = '';
                    // Возвращаем текст кнопки к "Добавить ученика" (или "Add Student")
                    document.getElementById('addStudentBtn').textContent =
                        (currentLanguage === 'ru')
                        ? translations.ru.buttons.addStudent
                        : translations.en.buttons.addStudent;
                }
            } else {
                // Добавление
                const student = {
                    id: Date.now(),
                    firstName,
                    lastName,
                    class: studentClass,
                    description,
                    marked: false
                };
                studentsData.push(student);
            }
            updateStudentTable();
            updateStudentSelects();
            saveToLocalStorage();
            studentForm.reset();
        });
    }

    function updateStudentTable() {
        const studentsTable = document.getElementById('studentsTable').querySelector('tbody');
        studentsTable.innerHTML = '';
        studentsData.forEach(student => {
            const row = studentsTable.insertRow();
            row.setAttribute('data-id', student.id);
            row.insertCell(0).textContent = student.firstName;
            row.insertCell(1).textContent = student.lastName;
            row.insertCell(2).textContent = student.class;
            row.insertCell(3).textContent = student.description;
            // Отметка
            const markCell = row.insertCell(4);
            const markCheckbox = document.createElement('input');
            markCheckbox.type = 'checkbox';
            markCheckbox.checked = student.marked || false;
            if (student.marked) {
                row.style.backgroundColor = "#dff0d8";
            }
            markCheckbox.addEventListener('change', function() {
                student.marked = markCheckbox.checked;
                row.style.backgroundColor = markCheckbox.checked ? "#dff0d8" : "";
                saveToLocalStorage();
            });
            markCell.appendChild(markCheckbox);

            // Действия
            const actionsCell = row.insertCell(5);
            const editBtn = document.createElement('button');
            editBtn.textContent = (currentLanguage === 'ru') ? 'Редактировать' : 'Edit';
            editBtn.addEventListener('click', () => editStudent(student.id));
            actionsCell.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = (currentLanguage === 'ru') ? 'Удалить' : 'Delete';
            deleteBtn.addEventListener('click', () => deleteStudent(student.id));
            actionsCell.appendChild(deleteBtn);
        });
    }

    function editStudent(id) {
        const student = studentsData.find(s => s.id === id);
        if (!student) return;
        document.getElementById('firstName').value = student.firstName;
        document.getElementById('lastName').value = student.lastName;
        document.getElementById('class').value = student.class;
        document.getElementById('description').value = student.description;
        let idInput = document.getElementById('studentId');
        if (!idInput) {
            idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.id = 'studentId';
            document.getElementById('studentForm').appendChild(idInput);
        }
        idInput.value = id;
        // Меняем кнопку на "Обновить ученика" / "Update Student"
        document.getElementById('addStudentBtn').textContent =
            (currentLanguage === 'ru')
            ? 'Обновить ученика'
            : 'Update Student';
    }

    function deleteStudent(id) {
        if (!confirm((currentLanguage === 'ru') ? 'Вы уверены, что хотите удалить этого ученика?' : 'Are you sure you want to delete this student?')) {
            return;
        }
        const index = studentsData.findIndex(s => s.id === id);
        if (index !== -1) {
            studentsData.splice(index, 1);
            // Удаляем связанные занятия
            schedulesData.forEach((lesson, idx) => {
                if (parseInt(lesson.studentId) === id) {
                    schedulesData.splice(idx, 1);
                }
            });
            updateStudentTable();
            updateScheduleTable();
            updateStudentSelects();
            renderCalendar(currentCalendarDate);
            saveToLocalStorage();
        }
    }

    // --- ЛОГИКА ДЛЯ РАСПИСАНИЯ ---

    function setupScheduleForm() {
        const scheduleForm = document.getElementById('scheduleForm');
        scheduleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const title = document.getElementById('lessonTitle').value;
            const dateTime = document.getElementById('lessonDateTime').value;
            const studentId = document.getElementById('studentSelect').value;
            const notes = document.getElementById('lessonNotes').value;

            const student = studentsData.find(s => s.id.toString() === studentId);
            const studentName = student ? `${student.firstName} ${student.lastName}` : (currentLanguage === 'ru' ? 'Ученик не выбран' : 'No student selected');

            const lessonIdInput = document.getElementById('lessonId');
            if (lessonIdInput && lessonIdInput.value) {
                // Редактирование
                const lessonId = parseInt(lessonIdInput.value);
                const index = schedulesData.findIndex(l => l.id === lessonId);
                if (index !== -1) {
                    // Удаляем старое событие из календаря
                    const oldLesson = schedulesData[index];
                    const oldDateObj = new Date(oldLesson.dateTime);
                    const oldDateKey = formatDateKey(oldDateObj);
                    if (calendarEvents[oldDateKey]) {
                        const eventIndex = calendarEvents[oldDateKey].findIndex(e => e.id === lessonId);
                        if (eventIndex !== -1) {
                            calendarEvents[oldDateKey].splice(eventIndex, 1);
                            if (calendarEvents[oldDateKey].length === 0) {
                                delete calendarEvents[oldDateKey];
                            }
                        }
                    }
                    schedulesData[index] = {
                        id: lessonId,
                        title,
                        dateTime,
                        studentId,
                        studentName,
                        notes
                    };
                    addEventToCalendar(schedulesData[index]);
                    lessonIdInput.value = '';
                    // Кнопка -> "Добавить занятие" / "Add Lesson"
                    document.getElementById('addLessonBtn').textContent =
                        (currentLanguage === 'ru') ? 'Добавить занятие' : 'Add Lesson';
                }
            } else {
                // Добавление
                const lesson = {
                    id: Date.now(),
                    title,
                    dateTime,
                    studentId,
                    studentName,
                    notes
                };
                schedulesData.push(lesson);
                addEventToCalendar(lesson);
            }
            updateScheduleTable();
            renderCalendar(currentCalendarDate);
            saveToLocalStorage();
            scheduleForm.reset();
        });
    }

    function updateScheduleTable() {
        const scheduleTable = document.getElementById('scheduleTable').querySelector('tbody');
        scheduleTable.innerHTML = '';
        schedulesData.forEach(lesson => {
            const row = scheduleTable.insertRow();
            row.setAttribute('data-id', lesson.id);
            row.insertCell(0).textContent = lesson.title;
            row.insertCell(1).textContent = formatDateTime(lesson.dateTime);
            row.insertCell(2).textContent = lesson.studentName;
            row.insertCell(3).textContent = lesson.notes;
            const actionsCell = row.insertCell(4);

            const editBtn = document.createElement('button');
            editBtn.textContent = (currentLanguage === 'ru') ? 'Редактировать' : 'Edit';
            editBtn.addEventListener('click', () => editLesson(lesson.id));
            actionsCell.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = (currentLanguage === 'ru') ? 'Удалить' : 'Delete';
            deleteBtn.addEventListener('click', () => deleteLesson(lesson.id));
            actionsCell.appendChild(deleteBtn);
        });
    }

    function editLesson(id) {
        const lesson = schedulesData.find(l => l.id === id);
        if (!lesson) return;
        document.getElementById('lessonTitle').value = lesson.title;
        document.getElementById('lessonDateTime').value = lesson.dateTime;
        document.getElementById('studentSelect').value = lesson.studentId;
        document.getElementById('lessonNotes').value = lesson.notes;

        let idInput = document.getElementById('lessonId');
        if (!idInput) {
            idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.id = 'lessonId';
            document.getElementById('scheduleForm').appendChild(idInput);
        }
        idInput.value = id;
        // Кнопка -> "Обновить занятие" / "Update Lesson"
        document.getElementById('addLessonBtn').textContent =
            (currentLanguage === 'ru') ? 'Обновить занятие' : 'Update Lesson';
    }

    function deleteLesson(id) {
        if (!confirm((currentLanguage === 'ru') ? 'Вы уверены, что хотите удалить это занятие?' : 'Are you sure you want to delete this lesson?')) {
            return;
        }
        const index = schedulesData.findIndex(l => l.id === id);
        if (index !== -1) {
            const lesson = schedulesData[index];
            // Удаляем событие из календаря
            const dateObj = new Date(lesson.dateTime);
            const dateKey = formatDateKey(dateObj);
            if (calendarEvents[dateKey]) {
                const eventIndex = calendarEvents[dateKey].findIndex(e => e.id === id);
                if (eventIndex !== -1) {
                    calendarEvents[dateKey].splice(eventIndex, 1);
                    if (calendarEvents[dateKey].length === 0) {
                        delete calendarEvents[dateKey];
                    }
                }
            }
            schedulesData.splice(index, 1);
            updateScheduleTable();
            renderCalendar(currentCalendarDate);
            saveToLocalStorage();
        }
    }

    // --- КАЛЕНДАРЬ ---

    function setupCalendar() {
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const todayBtn = document.getElementById('today');
        prevMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar(currentCalendarDate);
        });
        nextMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar(currentCalendarDate);
        });
        todayBtn.addEventListener('click', () => {
            currentCalendarDate = new Date();
            renderCalendar(currentCalendarDate);
        });
        setupEventModal();
        renderCalendar(currentCalendarDate);
    }

    function renderCalendar(date) {
        const calendarGrid = document.getElementById('calendarGrid');
        const monthYearHeader = document.getElementById('currentMonthYear');
        // Название месяца
        const monthName = date.toLocaleString((currentLanguage === 'ru') ? 'ru-RU' : 'en-US', { month: 'long' });
        const year = date.getFullYear();
        monthYearHeader.textContent = `${monthName} ${year}`;

        while (calendarGrid.children.length > 7) {
            calendarGrid.removeChild(calendarGrid.lastChild);
        }
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        let startDayIndex = firstDay.getDay();
        startDayIndex = startDayIndex === 0 ? 6 : startDayIndex - 1;
        const lastDayPrevMonth = new Date(date.getFullYear(), date.getMonth(), 0).getDate();
        const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
        const today = new Date();

        // Дни предыдущего месяца
        for (let i = 0; i < startDayIndex; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day other-month';
            const dayNumber = lastDayPrevMonth - startDayIndex + i + 1;
            dayDiv.innerHTML = `<div class="calendar-day-number">${dayNumber}</div>`;
            const prevMonthDate = new Date(date.getFullYear(), date.getMonth() - 1, dayNumber);
            addEventsToDay(dayDiv, formatDateKey(prevMonthDate));
            calendarGrid.appendChild(dayDiv);
        }
        // Дни текущего месяца
        for (let i = 1; i <= daysInMonth; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            if (today.getDate() === i && today.getMonth() === date.getMonth() && today.getFullYear() === date.getFullYear()) {
                dayDiv.classList.add('today');
            }
            dayDiv.innerHTML = `<div class="calendar-day-number">${i}</div>`;
            const currentDate = new Date(date.getFullYear(), date.getMonth(), i);
            addEventsToDay(dayDiv, formatDateKey(currentDate));
            dayDiv.addEventListener('click', () => {
                openEventModal(currentDate);
            });
            calendarGrid.appendChild(dayDiv);
        }
        // Дни следующего месяца
        const totalCells = 42;
        const remainingCells = totalCells - (startDayIndex + daysInMonth);
        for (let i = 1; i <= remainingCells; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day other-month';
            dayDiv.innerHTML = `<div class="calendar-day-number">${i}</div>`;
            const nextMonthDate = new Date(date.getFullYear(), date.getMonth() + 1, i);
            addEventsToDay(dayDiv, formatDateKey(nextMonthDate));
            calendarGrid.appendChild(dayDiv);
        }
    }

    function formatDateKey(date) {
        return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
    }

    function addEventsToDay(dayDiv, dateKey) {
        if (calendarEvents[dateKey]) {
            calendarEvents[dateKey].forEach(event => {
                const eventEl = document.createElement('div');
                eventEl.className = 'calendar-event';
                eventEl.title = `${event.title} - ${event.studentName} - ${event.time}`;
                eventEl.textContent = `${event.time} ${event.title}`;
                dayDiv.appendChild(eventEl);
            });
        }
    }

    // --- МОДАЛЬНОЕ ОКНО КАЛЕНДАРЯ ---

    function setupEventModal() {
        const modal = document.getElementById('eventModal');
        const closeBtn = modal.querySelector('.close');
        const form = document.getElementById('calendarEventForm');
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const dateStr = document.getElementById('eventDate').value;
            const title = document.getElementById('eventTitle').value;
            const time = document.getElementById('eventTime').value;
            const studentId = document.getElementById('eventStudent').value;
            const notes = document.getElementById('eventNotes').value;

            const student = studentsData.find(s => s.id.toString() === studentId);
            const studentName = student ? `${student.firstName} ${student.lastName}` : (currentLanguage === 'ru' ? 'Ученик не выбран' : 'No student selected');

            const event = {
                id: Date.now(),
                title,
                time,
                studentId,
                studentName,
                notes,
                date: dateStr
            };
            addEventToCalendar(event);
            renderCalendar(currentCalendarDate);
            modal.style.display = 'none';
            form.reset();
        });
    }

    function openEventModal(date) {
        const modal = document.getElementById('eventModal');
        const dateInput = document.getElementById('eventDate');
        const formattedDate = formatDateKey(date);
        dateInput.value = formattedDate;
        modal.style.display = 'block';
    }

    function addEventToCalendar(event) {
        let dateKey;
        if (event.dateTime) {
            const dateObj = new Date(event.dateTime);
            dateKey = formatDateKey(dateObj);
            const timeStr = dateObj.toLocaleTimeString((currentLanguage === 'ru') ? 'ru-RU' : 'en-US', { hour: '2-digit', minute: '2-digit' });
            const calEvent = {
                id: event.id,
                title: event.title,
                time: timeStr,
                studentId: event.studentId,
                studentName: event.studentName,
                notes: event.notes
            };
            if (!calendarEvents[dateKey]) {
                calendarEvents[dateKey] = [];
            }
            calendarEvents[dateKey].push(calEvent);
        } else if (event.date && event.time) {
            dateKey = event.date;
            if (!calendarEvents[dateKey]) {
                calendarEvents[dateKey] = [];
            }
            calendarEvents[dateKey].push(event);
        }
    }

    // --- ПЛАТЕЖИ ---

    function setupPaymentForm() {
        const paymentForm = document.getElementById('paymentForm');
        paymentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const studentId = document.getElementById('paymentStudent').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;
            const description = document.getElementById('paymentDescription').value;
            const paymentMethod = document.getElementById('paymentMethod').value;

            const student = studentsData.find(s => s.id.toString() === studentId);
            const studentName = student ? `${student.firstName} ${student.lastName}` : (currentLanguage === 'ru' ? 'Ученик не выбран' : 'No student selected');

            const paymentIdInput = document.getElementById('paymentId');
            if (paymentIdInput && paymentIdInput.value) {
                // Редактирование
                const paymentId = parseInt(paymentIdInput.value);
                const index = paymentsData.findIndex(p => p.id === paymentId);
                if (index !== -1) {
                    paymentsData[index] = {
                        id: paymentId,
                        studentId,
                        studentName,
                        amount,
                        date,
                        description,
                        paymentMethod
                    };
                    paymentIdInput.value = '';
                    document.getElementById('addPaymentBtn').textContent =
                        (currentLanguage === 'ru') ? 'Добавить платеж' : 'Add Payment';
                }
            } else {
                // Добавление
                const payment = {
                    id: Date.now(),
                    studentId,
                    studentName,
                    amount,
                    date,
                    description,
                    paymentMethod
                };
                paymentsData.push(payment);
            }
            updatePaymentTable();
            saveToLocalStorage();
            paymentForm.reset();
        });
    }

    function updatePaymentTable() {
        const paymentTable = document.getElementById('paymentsTable').querySelector('tbody');
        paymentTable.innerHTML = '';

        const studentFilter = document.getElementById('paymentStudentFilter').value;
        let filteredPayments = [...paymentsData];
        if (studentFilter) {
            filteredPayments = filteredPayments.filter(p => p.studentId.toString() === studentFilter);
        }

        const totalAmount = filteredPayments.reduce((sum, payment) => sum + payment.amount, 0);
        // Пример обновления текста "Итого: ... ₽"
        // Полный перевод зависит от логики - здесь мы просто ставим нужную сумму
        // А сам префикс "Итого:" / "Total:" переключается через data-lang-key (headings.totalAmountPrefix).
        const totalAmountEl = document.getElementById('totalPaymentAmount');
        if (currentLanguage === 'ru') {
            totalAmountEl.textContent = `Итого: ${totalAmount.toFixed(2)} ₽`;
        } else {
            totalAmountEl.textContent = `Total: ${totalAmount.toFixed(2)} ₽`;
        }

        filteredPayments.forEach(payment => {
            const row = paymentTable.insertRow();
            row.setAttribute('data-id', payment.id);
            // Дата
            const dateCell = row.insertCell(0);
            const formattedDate = new Date(payment.date).toLocaleDateString((currentLanguage === 'ru') ? 'ru-RU' : 'en-US');
            dateCell.textContent = formattedDate;
            // Ученик
            row.insertCell(1).textContent = payment.studentName;
            // Сумма
            const amountCell = row.insertCell(2);
            amountCell.textContent = `${payment.amount.toFixed(2)} ₽`;
            // Описание
            row.insertCell(3).textContent = payment.description;
            // Способ оплаты
            row.insertCell(4).textContent = payment.paymentMethod;

            // Действия
            const actionsCell = row.insertCell(5);
            const editBtn = document.createElement('button');
            editBtn.textContent = (currentLanguage === 'ru') ? 'Редактировать' : 'Edit';
            editBtn.addEventListener('click', () => editPayment(payment.id));
            actionsCell.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = (currentLanguage === 'ru') ? 'Удалить' : 'Delete';
            deleteBtn.addEventListener('click', () => deletePayment(payment.id));
            actionsCell.appendChild(deleteBtn);
        });
    }

    function editPayment(id) {
        const payment = paymentsData.find(p => p.id === id);
        if (!payment) return;
        document.getElementById('paymentStudent').value = payment.studentId;
        document.getElementById('paymentAmount').value = payment.amount;
        document.getElementById('paymentDate').value = payment.date;
        document.getElementById('paymentDescription').value = payment.description;
        document.getElementById('paymentMethod').value = payment.paymentMethod;

        let idInput = document.getElementById('paymentId');
        if (!idInput) {
            idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.id = 'paymentId';
            document.getElementById('paymentForm').appendChild(idInput);
        }
        idInput.value = id;
        // Меняем текст кнопки на "Обновить платеж" / "Update Payment"
        document.getElementById('addPaymentBtn').textContent =
            (currentLanguage === 'ru') ? 'Обновить платеж' : 'Update Payment';
    }

    function deletePayment(id) {
        if (!confirm((currentLanguage === 'ru') ? 'Вы уверены, что хотите удалить этот платеж?' : 'Are you sure you want to delete this payment?')) {
            return;
        }
        const index = paymentsData.findIndex(p => p.id === id);
        if (index !== -1) {
            paymentsData.splice(index, 1);
            updatePaymentTable();
            saveToLocalStorage();
        }
    }

    // --- ПОИСК, ФИЛЬТР ---

    function setupStudentSearch() {
        const searchInput = document.getElementById('studentSearch');
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase();
            const rows = document.querySelectorAll('#studentsTable tbody tr');
            rows.forEach(row => {
                const firstName = row.cells[0].textContent.toLowerCase();
                const lastName = row.cells[1].textContent.toLowerCase();
                const cls = row.cells[2].textContent.toLowerCase();
                if (firstName.includes(searchTerm) || lastName.includes(searchTerm) || cls.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }

    function setupPaymentFilter() {
        const filterSelect = document.getElementById('paymentStudentFilter');
        filterSelect.addEventListener('change', () => {
            updatePaymentTable();
        });
    }

    // --- LOCALSTORAGE ---

    function saveToLocalStorage() {
        localStorage.setItem('studentsData', JSON.stringify(studentsData));
        localStorage.setItem('schedulesData', JSON.stringify(schedulesData));
        localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
        localStorage.setItem('paymentsData', JSON.stringify(paymentsData));
    }

    function loadFromLocalStorage() {
        const students = localStorage.getItem('studentsData');
        const schedules = localStorage.getItem('schedulesData');
        const events = localStorage.getItem('calendarEvents');
        const payments = localStorage.getItem('paymentsData');
        if (students) {
            studentsData.push(...JSON.parse(students));
            updateStudentTable();
        }
        if (schedules) {
            schedulesData.push(...JSON.parse(schedules));
            updateScheduleTable();
        }
        if (events) {
            Object.assign(calendarEvents, JSON.parse(events));
            renderCalendar(currentCalendarDate);
        }
        if (payments) {
            paymentsData.push(...JSON.parse(payments));
            updatePaymentTable();
        }
        updateStudentSelects();
    }

    // --- ВСПОМОГАТЕЛЬНЫЕ ---

    function updateStudentSelects() {
        const studentSelects = [
            document.getElementById('studentSelect'),
            document.getElementById('eventStudent'),
            document.getElementById('paymentStudent'),
            document.getElementById('paymentStudentFilter')
        ];
        studentSelects.forEach(select => {
            const selectedValue = select.value;
            while (select.options.length > 1) {
                select.remove(1);
            }
            studentsData.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.firstName} ${student.lastName}`;
                select.appendChild(option);
            });
            if (selectedValue) {
                select.value = selectedValue;
            }
        });
    }

    function formatDateTime(dateTimeStr) {
        const dateTime = new Date(dateTimeStr);
        // В зависимости от текущего языка форматируем дату
        const locale = (currentLanguage === 'ru') ? 'ru-RU' : 'en-US';
        return dateTime.toLocaleString(locale, {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // --- ИНИЦИАЛИЗАЦИЯ ---

    document.addEventListener('DOMContentLoaded', () => {
        // Добавляем столбец "Отметка" и "Действия" в таблицу учеников
        const studentsTableHeader = document.querySelector('#studentsTable thead tr');
        const markTh = document.createElement('th');
        markTh.textContent = (currentLanguage === 'ru') ? 'Отметка' : 'Mark';
        studentsTableHeader.appendChild(markTh);
        const actionsTh = document.createElement('th');
        actionsTh.textContent = (currentLanguage === 'ru') ? 'Действия' : 'Actions';
        studentsTableHeader.appendChild(actionsTh);

        // Добавляем вкладку "Платежи"
        const tabs = document.querySelector('.tabs');
        const paymentTab = document.createElement('button');
        paymentTab.id = 'navPayments';
        paymentTab.className = 'tab-button';
        paymentTab.setAttribute('data-target', 'paymentsSection');
        paymentTab.setAttribute('data-lang-key', 'nav.payments');
        paymentTab.textContent = 'Платежи';
        tabs.appendChild(paymentTab);

        // Перемещаем секцию платежей (если нужно, чтобы она шла следом)
        const paymentsSection = document.getElementById('paymentsSection');
        document.body.insertBefore(paymentsSection, document.querySelector('script'));

        setupTabs();
        setupStudentForm();
        setupScheduleForm();
        setupCalendar();
        setupPaymentForm();
        setupStudentSearch();
        setupPaymentFilter();
        setupThemeToggle();
        setupLanguageToggle();
        loadFromLocalStorage();

        // Вызовем updateLanguage() сразу, чтобы подтянуть все тексты
        updateLanguage();

        // Для режима редактирования учеников (или занятий, платежей) меняем текст кнопки
        // после загрузки, если нужно (обычно не нужно).
    });
</script>

</body>
</html>
